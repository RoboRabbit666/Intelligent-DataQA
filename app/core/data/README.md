# DataQA Pipeline

1. 问题改写/追问处理
2. 实体识别增强
3. 业务知识搜索（提供背景理解）

4. 并行快速路径检查：
   ├─4a. FAQ匹配（阈值≥0.9）
   └─4b. API定位（阈值≥0.8）
   
   判断逻辑：
   - API≥0.8 且 FAQ≥0.9 → 返回API（API优先）
   - API≥0.8 且 FAQ<0.9 → 返回API
   - API<0.8 且 FAQ≥0.9 → 返回FAQ
   - API<0.8 且 FAQ<0.9 → 继续步骤5

5. 表格定位（只在步骤4a和4b都不满足时执行）

6. SQL生成：
   - 集成业务知识上下文
   - 集成表格schema
   - 如果FAQ分数在0.7-0.9，作为参考示例
   - 如果FAQ<0.7，不使用FAQ

┌─────────────────────────┐
│  1. 问题改写/追问处理    │
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  2. 实体识别增强         │
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  3. 业务知识搜索         │ ← 提供背景理解
└────────────┬────────────┘
             ▼
    ┌────────┼────────┐
    ▼                 ▼
┌──────────┐    ┌──────────┐
│ 4a. FAQ  │    │ 4b. API  │
│ 高分匹配  │    │   定位    │
└────┬─────┘    └────┬─────┘
     │               │
  [≥0.9分]        [找到合适API]
     │               │
  直接返回SQL     直接返回API调用   ←步骤4判断条件
  [流程结束]      [流程结束]
     │               │
  [<0.9分]        [无合适API]
     └───────┬───────┘
             ▼
┌─────────────────────────┐
│  5. 表格定位             │ ← 只有4a和4b都不满足时执行
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  6. SQL生成              │ ← 生成新的SQL
└─────────────────────────┘


      ┌──────┴──────┐
      │  步骤4判断   │
      └──────┬──────┘