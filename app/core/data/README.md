<!-- # DataQA Pipeline

1. 问题改写/追问处理
2. 实体识别增强
3. 业务知识搜索（提供背景理解）

4. 并行快速路径检查：
   ├─4a. FAQ匹配（阈值≥0.9）
   └─4b. API定位（阈值≥0.8）
   
   判断逻辑：
   - API≥0.8 且 FAQ≥0.9 → 返回API（API优先）
   - API≥0.8 且 FAQ<0.9 → 返回API
   - API<0.8 且 FAQ≥0.9 → 返回FAQ
   - API<0.8 且 FAQ<0.9 → 继续步骤5

5. 表格定位（只在步骤4a和4b都不满足时执行）

6. SQL生成：
   - 集成业务知识上下文
   - 集成表格schema
   - 如果FAQ分数在0.7-0.9，作为参考示例
   - 如果FAQ<0.7，不使用FAQ

┌─────────────────────────┐
│  1. 问题改写/追问处理    │
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  2. 实体识别增强         │
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  3. 业务知识搜索         │ ← 提供背景理解
└────────────┬────────────┘
             ▼
    ┌────────┼────────┐
    ▼                 ▼
┌──────────┐    ┌──────────┐
│ 4a. FAQ  │    │ 4b. API  │
│ 高分匹配  │    │   定位    │
└────┬─────┘    └────┬─────┘
     │               │
  [≥0.9分]        [找到合适API]
     │               │
  直接返回SQL     直接返回API调用   ←步骤4判断条件
  [流程结束]      [流程结束]
     │               │
  [<0.9分]        [无合适API]
     └───────┬───────┘
             ▼
┌─────────────────────────┐
│  5. 表格定位             │ ← 只有4a和4b都不满足时执行
└────────────┬────────────┘
             ▼
┌─────────────────────────┐
│  6. SQL生成              │ ← 生成新的SQL
└─────────────────────────┘ -->


## DataQA Pipeline

### Overview
1. 问题改写/追问处理  
2. 实体识别增强  
3. 业务知识搜索（提供背景理解）  
4. 并行快速路径检查：  
   - 4a. FAQ匹配（阈值 ≥ 0.9）  
   - 4b. API定位（阈值 ≥ 0.8，**API优先**）  
5. 表格定位（仅当 4a 与 4b 均不满足时执行）  
6. SQL生成  
   - 集成业务知识上下文  
   - 集成表格 schema  
   - FAQ 分数在 0.7–0.9：仅作参考示例  
   - FAQ < 0.7：不使用 FAQ

### Fast-path decision table
| API ≥ 0.8 | FAQ ≥ 0.9 | 结果 |
|---|---|---|
| 是 | 是 | 返回 API（**API 优先**） |
| 是 | 否 | 返回 API |
| 否 | 是 | 返回 FAQ |
| 否 | 否 | 进入步骤 5（表格定位） |

### End-to-end flow (Mermaid)
```mermaid
flowchart TB
    A[1. 问题改写/追问处理] --> B[2. 实体识别增强]
    B --> C[3. 业务知识搜索（背景理解）]

    %% 并行快速路径（API 优先）
    C --> E{4b. API 定位<br/>分数 ≥ 0.8 ?}
    C --> D{4a. FAQ 匹配<br/>分数 ≥ 0.9 ?}

    E -->|是| K{FAQ ≥ 0.9 ?}
    K -->|是| F[返回 API 调用<br/>（流程结束，API 优先）]
    K -->|否| F[返回 API 调用<br/>（流程结束）]

    E -->|否| D
    D -->|是| G[返回 FAQ 答案/SQL<br/>（流程结束）]
    D -->|否| H[5. 表格定位]

    H --> I[6. SQL 生成<br/>• 业务知识上下文<br/>• 表格 schema<br/>• FAQ 0.7–0.9 仅作示例<br/>• FAQ < 0.7 不使用 FAQ]